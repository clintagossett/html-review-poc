# ADR 0002: HTML Artifact Storage Strategy

**Status:** Accepted
**Date:** 2024-12-24
**Decision Maker:** Clint Gossett
**Updated:** 2024-12-24 (Revised: Access control requirements simplified the decision)

## TL;DR

HTTP proxy with per-request permission checks is mandatory due to hierarchical access control requirements. MVP uses Convex File Storage ($25/mo fixed). Migrate to Cloudflare Workers + R2 when bandwidth exceeds 40GB/month.

## Quick Reference

| Item | Value |
|------|-------|
| **Storage backend (MVP)** | Convex File Storage |
| **Storage backend (Scale)** | Cloudflare R2 |
| **Migration trigger** | >40GB bandwidth/month |
| **Max ZIP size** | 100MB |
| **Max extracted size** | 200MB |
| **Max files per ZIP** | 500 |
| **Max individual file** | 20MB |
| **Cost (MVP)** | $25/month fixed |

## Decision Drivers (Priority Order)

1. **Fine-grained access control** - Permissions at workspace/project/document/file levels
2. **HTML compatibility** - Preserve relative paths for multi-file projects
3. **Fixed costs** - Predictable pricing during MVP phase
4. **Simple architecture** - One system (Convex) handles DB + storage + HTTP
5. **Clear migration path** - Move to Workers + R2 when scale justifies effort

## Related Decisions

- [ADR 0001: Authentication Provider](./0001-authentication-provider.md) - Auth strategy affects permission checks
- [Deployment Environments](../deployment-environments.md) - Infrastructure context

## Context

The HTML Review Platform needs to store and serve HTML artifacts generated by AI agents (Claude Code, Cursor, etc.) with **fine-grained access control**.

### Critical Requirement: Hierarchical Permissions

The platform requires read/write permissions at multiple levels:
- **Workspace level** - Members, admins, owners
- **Project level** - Editors, commenters, viewers
- **Document level** - Version-specific access
- **File level** - Individual asset permissions

**This requirement fundamentally shapes the storage architecture.** Every file request must check authorization before serving content. This eliminates simple approaches like public URLs or basic signed URLs.

### Existing Implementation

This project has a working Convex Chef implementation that:
- Accepts ZIP uploads
- Extracts files asynchronously with JSZip
- Stores individual files in Convex storage
- Serves files via **HTTP proxy with per-request permission checks**

This ADR evaluates whether this architecture is correct and when to consider migration.

Based on sample analysis, we have two distinct types of content:

### Type 1: Simple HTML Documents
- Single self-contained HTML file
- May reference external CDN resources
- Example: Welcome pages, simple docs
- Size: 1-10KB typically
- Example: `samples/simple-html/v1/index.html`

### Type 2: Complex HTML Projects
- Multi-file structure with dependencies
- Contains: HTML, CSS, JavaScript, JSON data, images
- Uses relative paths between files
- Requires directory structure preservation
- Example: `samples/charting/v1/` with:
  - `index.html` (1KB)
  - `app.js` (1KB)
  - `assets/chart-data.json` (0.5KB)
  - `assets/logo.png` (2.1KB)
- Total: 16KB uncompressed, 3.8KB compressed
- Often uploaded as ZIP files

## Problem Statement

Complex HTML projects have file interdependencies that require:
1. **Directory structure** - Relative paths like `./assets/logo.png` must resolve
2. **Multiple files** - Each with proper Content-Type headers
3. **Cross-file requests** - JavaScript fetching JSON data files
4. **Versioning** - v1/, v2/ folder structure for iterations
5. **Per-request authorization** - Check permissions before serving each file

These requirements **mandate an HTTP proxy architecture**. We cannot use:
- ‚ùå Public blob storage URLs (no access control)
- ‚ùå Signed URLs (breaks relative paths, no granular permissions)
- ‚ùå Direct database serving (no Content-Type headers, complex path resolution)

## Decision

**Use HTTP proxy with fine-grained permission checks for all file serving.**

### Storage Strategy by Content Type

1. **Simple HTML** ‚Üí Store in Convex database (as text)
2. **Complex projects** ‚Üí Store in Convex file storage (MVP) or R2 (scale)
3. **All metadata & permissions** ‚Üí Store in Convex database

### Serving Strategy (Non-Negotiable)

**All files served through HTTP proxy** that:
1. Authenticates the user
2. Checks hierarchical permissions (workspace ‚Üí project ‚Üí document ‚Üí file)
3. Maps friendly paths (`/project/123/v1/assets/logo.png`) to storage identifiers
4. Fetches file from storage backend
5. Returns file with proper Content-Type headers

### Storage Backend Choice

**MVP (0-12 months):** Convex File Storage
- Current implementation is correct
- Within Professional plan limits (100GB storage, 50GB bandwidth/month)
- Cost: $25/month (fixed)
- Migration trigger: Bandwidth consistently >40GB/month

**Scale (12+ months):** Cloudflare Workers + R2
- Workers handle permission checks and serving
- R2 provides zero-egress storage
- Cost: ~$30/month at any bandwidth level
- Migrate when bandwidth savings justify migration effort

## Storage Backend Options

### MVP: Convex File Storage (Recommended)

**Current implementation uses Convex storage - this is correct for MVP.**

| Aspect | Details |
|--------|---------|
| Storage cost | Included in Professional plan (100GB) |
| Bandwidth cost | Included in Professional plan (50GB/month) |
| Total cost | **$25/month (fixed)** |
| Migration trigger | Bandwidth consistently >40GB/month |

**Why Convex storage for MVP:**
- ‚úÖ **Already implemented** - Working code, no migration needed
- ‚úÖ **Fixed costs** - Predictable pricing during growth
- ‚úÖ **Simple architecture** - One system for DB + storage + HTTP
- ‚úÖ **Within limits** - 100GB storage, 50GB bandwidth more than sufficient for 12+ months
- ‚úÖ **No setup overhead** - No external accounts, API keys, or integrations

### Scale: Cloudflare R2 (Future Migration)

**When bandwidth consistently exceeds 40GB/month, migrate to R2 for cost savings.**

| Provider | Storage | Egress | At 200GB bandwidth/mo |
|----------|---------|--------|----------------------|
| **Cloudflare R2** | $0.015/GB | **$0** | **$0.30/month** |
| Convex overage | Included | $0.30/GB | **$70/month** |

**Migration approach:**
- Use Cloudflare Workers for HTTP proxy (not Convex HTTP)
- Workers call Convex for permission checks
- Workers fetch from R2 and serve
- Zero egress fees (Workers ‚Üí R2 is internal traffic)

## Consequences

### Positive

- ‚úÖ **Fine-grained access control** - Per-request permission checks at all levels
- ‚úÖ **Preserves file structure** - Relative paths work naturally through proxy
- ‚úÖ **Secure by default** - No public URLs, all files require authorization
- ‚úÖ **Simple MVP architecture** - One system (Convex) handles everything
- ‚úÖ **Fixed costs** - $25/month regardless of traffic during MVP phase
- ‚úÖ **Already implemented** - No migration needed to start
- ‚úÖ **Clear migration path** - Move to Cloudflare Workers + R2 when bandwidth exceeds limits
- ‚úÖ **Version-friendly** - Easy to store v1/, v2/ with isolated permissions
- ‚úÖ **Share link support** - Token-based access without user accounts

### Negative

- ‚ö†Ô∏è **HTTP proxy latency** - Every file request goes through permission check (unavoidable given requirements)
- ‚ö†Ô∏è **No CDN caching** - Files are private, can't use public CDN (acceptable tradeoff)
- ‚ö†Ô∏è **Future migration needed** - Must move to Workers + R2 if bandwidth grows >40GB/month
- ‚ö†Ô∏è **Permission query overhead** - Every file request queries database (can optimize with caching)

### Why This Decision Was Simple

**Access control requirements eliminated most alternatives:**
1. Can't use public URLs ‚Üí Need authentication
2. Can't use simple signed URLs ‚Üí Need hierarchical permissions (workspace/project/document/file)
3. Can't skip proxy ‚Üí Need to map friendly paths to storage IDs

**The only choice was:**
- MVP: HTTP proxy in Convex (simple, already working)
- Scale: HTTP proxy in Cloudflare Workers (cost optimization)

## Alternatives Considered

**Note:** Access control requirements eliminated most alternatives before cost became a factor.

### Alt 1: Public Blob Storage (R2/Vercel/S3)

**Approach:** Store files in public blob storage, return URLs to frontend

**Rejected because:**
- ‚ùå **No access control** - Anyone with URL can access files
- ‚ùå Can't implement workspace/project/file permissions
- ‚ùå Can't revoke access when user leaves workspace
- ‚ùå No way to check share link expiration
- **Fatal flaw:** Incompatible with core product requirement

### Alt 2: Signed URLs with Time-Limited Access

**Approach:** Generate short-lived signed URLs for each file

**Rejected because:**
- ‚ùå **Breaks relative paths** - HTML expects `./app.js`, not `https://r2.../projects/123/app.js?signature=...`
- ‚ùå **No granular permissions** - Can't check workspace membership, project role, or document version access
- ‚ùå Complex to manage - Must pre-sign all referenced files
- ‚ùå Can't revoke access mid-session
- **Fatal flaw:** Relative paths are core to HTML artifact compatibility

### Alt 3: Bundle Everything into Single HTML

**Approach:** Inline all CSS/JS, convert images to data URIs, embed JSON

**Rejected because:**
- ‚ùå Complex bundling logic to build and maintain
- ‚ùå Data URIs bloat file size significantly (base64 encoding)
- ‚ùå Breaks debugging/source maps
- ‚ùå Can't version individual files
- ‚ùå Still need permission checks on the single file
- **Verdict:** Doesn't solve the access control problem, adds complexity

### Alt 4: Store ZIP Files, Unzip on Every Request

**Approach:** Store the .zip file (3.8KB) directly, extract on each view

**Rejected because:**
- ‚ùå Must unzip on every view (slow, CPU-intensive)
- ‚ùå Can't check permissions on individual files
- ‚ùå Memory intensive for large projects
- ‚ùå Complex serving logic to extract and cache
- **Verdict:** Performance and permission granularity issues

### Alt 5: Direct Convex Database Storage (Not File Storage)

**Approach:** Store each file as text/base64 in database documents

**Rejected because:**
- ‚ùå Large binary files bloat database
- ‚ùå 1MB document size limit
- ‚ùå Inefficient for images/assets
- ‚ùå Still requires HTTP proxy for serving (no advantage)
- **Verdict:** Wrong tool for the job

### Why HTTP Proxy Was The Only Option

All alternatives failed because they either:
1. **Couldn't implement fine-grained permissions** (public URLs, signed URLs)
2. **Broke HTML compatibility** (bundling, path rewriting)
3. **Had poor performance** (ZIP extraction, database blobs)

**HTTP proxy is the only architecture that:**
- ‚úÖ Checks permissions on every request
- ‚úÖ Preserves relative paths
- ‚úÖ Maps friendly paths to storage IDs
- ‚úÖ Serves files with proper Content-Type headers

The choice wasn't *whether* to use HTTP proxy, but *where* to run it (Convex or Cloudflare Workers).

## Upload Limits and File Restrictions

### ZIP Upload Limits

**Technical constraints from Convex:**
- Standard upload URL: No hard limit, but **2-minute timeout** on POST requests
- HTTP Actions: **20MB maximum**
- Browser limits: ~2GB (varies by browser)

**Recommended platform limits (MVP):**

| Limit Type | Value | Rationale |
|------------|-------|-----------|
| **Total ZIP size** | **100MB** | Practical limit given upload timeout, extraction time, and typical use case |
| **Individual file size** | **20MB** | Prevents single large files from dominating storage |
| **Total extracted size** | **200MB** | ZIP compression typically 50-70%, prevents abuse |
| **Maximum files per ZIP** | **500 files** | Prevents extraction performance issues |

### File Type Restrictions

**Allowed file types:**
- **HTML:** `.html`, `.htm`
- **Styles:** `.css`
- **Scripts:** `.js`, `.mjs`
- **Data:** `.json`, `.xml`
- **Images:** `.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.webp`, `.ico`
- **Fonts:** `.woff`, `.woff2`, `.ttf`, `.otf`

**Blocked file types (MVP):**
- **Video:** `.mp4`, `.webm`, `.mov`, `.avi` (see rationale below)
- **Audio:** `.mp3`, `.wav`, `.ogg`
- **Archives:** `.zip`, `.tar`, `.gz` (nested archives)
- **Executables:** `.exe`, `.sh`, `.app`
- **Server-side:** `.php`, `.py`, `.rb`, `.java`

### Why No Videos in MVP?

**Videos are excluded from MVP for strong technical and product reasons:**

| Concern | Impact |
|---------|--------|
| **Storage cost** | Single 1080p video = 100MB+ (equivalent to 1,000 HTML projects) |
| **Bandwidth cost** | Every view streams entire video (vs. HTML caches well) |
| **Not typical AI output** | Claude Code, Cursor, etc. generate static HTML, not video content |
| **Use case mismatch** | Platform is for reviewing HTML artifacts (dashboards, docs, apps) |
| **Extraction performance** | Large files slow down async ZIP extraction |

**Example cost impact:**
- 10 projects with 100MB videos = 1GB storage (uses 10% of plan limit)
- 1,000 views = 100GB bandwidth (exceeds Professional plan entirely)

**Future consideration:**
- Add video support when migrating to R2 (zero egress fees)
- Implement video-specific limits (e.g., 50MB max, 30 seconds max)
- Require separate upload flow (not in ZIP)

### Individual File Size Limits

| File Type | Limit | Rationale |
|-----------|-------|-----------|
| HTML files | 5MB | Larger than any reasonable AI-generated HTML |
| CSS files | 5MB | Includes large design systems |
| JS files | 10MB | Includes bundled libraries |
| JSON files | 10MB | Large data files for charts/dashboards |
| Images (PNG/JPG) | 10MB | High-res screenshots, design assets |
| SVG files | 2MB | Vector graphics, icons |
| Fonts | 2MB per file | Web font files |

### Storage Capacity

**Convex Professional Plan:**
- **Total storage:** 100GB
- **Bandwidth:** 50GB/month
- **Estimated capacity:**
  - ~5,000 projects at 20MB average = 100GB
  - ~10,000 projects at 10MB average = 100GB
  - With 100MB ZIP limit, max ~1,000 full-size projects

**Migration trigger:**
- Storage approaching 80GB (80% of limit)
- Bandwidth consistently >40GB/month
- Whichever comes first ‚Üí migrate to R2

## Cost Projections

### MVP (100 projects: 70 simple, 30 complex)
- **Convex Professional plan:** $25/month (fixed)
  - Includes: 100GB storage, 50GB bandwidth
  - Simple HTML (70 √ó 5KB = 350KB) ‚Üí Included
  - Complex projects (30 √ó 20KB = 600KB) ‚Üí Included
  - Bandwidth (10GB/month) ‚Üí Included
- **Total: $25/month** üéâ

### Growth (1,000 projects: 700 simple, 300 complex)
- **Convex Professional plan:** $25/month (fixed)
  - Storage used: 3.5MB + 6MB = 9.5MB ‚Üí Well within 100GB
  - Bandwidth (30GB/month) ‚Üí Within 50GB limit
- **Total: $25/month** (no overage charges)

### Scale Phase 1 (5,000 projects, 200GB bandwidth/month)
**Option A: Stay on Convex with overages**
- Base: $25/month
- Bandwidth overage: 150GB √ó $0.30 = **$45/month**
- **Total: $70/month**

**Option B: Migrate to Cloudflare Workers + R2**
- Cloudflare Workers: $5/month (10M requests)
- R2 storage (50GB): $0.75/month
- R2 bandwidth: $0 (zero egress)
- Convex (database only): $25/month
- **Total: $30.75/month** ‚Üê **Migrate here**

### Scale Phase 2 (20,000 projects, 500GB bandwidth/month)
- Cloudflare Workers: $5/month
- R2 storage (200GB): $3/month
- R2 bandwidth: $0
- Convex (database): $25/month
- **Total: $33/month** vs $175/month on Convex alone

**Migration trigger:** Bandwidth consistently >40GB/month (saves ~$40/month)

## MVP Optimizations

Before migrating to R2, optimize current Convex implementation:

### 1. Delete Original ZIP After Extraction (High Priority)
**Current:** Original ZIP stored permanently (~50% of storage)
**Optimization:** Delete ZIP after successful extraction
**Impact:** 50% storage savings
**Effort:** 1 hour (add `ctx.storage.delete()` call)

### 2. Add Permission Caching (Medium Priority)
**Current:** Every file request queries database for permissions
**Optimization:** Cache permission check results in memory (5-minute TTL)
**Impact:** 80% reduction in permission queries, faster response times
**Effort:** 4 hours (implement cache layer with expiration)

### 3. Implement Bandwidth Monitoring (Low Priority)
**Current:** No visibility into bandwidth usage
**Optimization:** Track bandwidth per project/workspace, display in dashboard
**Impact:** Early warning before hitting limits
**Effort:** 6 hours (add tracking table, queries, dashboard UI)

### 4. Add Content-Type Validation (Low Priority)
**Current:** Accepts any file type
**Optimization:** Whitelist web-safe file types (HTML, CSS, JS, images)
**Impact:** Prevent abuse, reduce storage of unnecessary files
**Effort:** 2 hours (add validation in upload flow)

**Total optimization effort:** 13 hours (1-2 days)
**Storage savings:** 50% immediately
**Performance improvement:** Significant (permission caching)

## Summary

**Key Decision:** Fine-grained access control requirements mandate HTTP proxy architecture. The only choice is where the proxy runs.

**MVP (0-12 months):**
- ‚úÖ Current Convex implementation is **correct**
- ‚úÖ HTTP proxy in Convex with per-request permission checks
- ‚úÖ Files stored in Convex storage
- ‚úÖ Fixed $25/month cost
- ‚úÖ Quick optimizations available (delete ZIP, permission caching)

**Scale (12+ months, >40GB bandwidth/month):**
- ‚û°Ô∏è Migrate HTTP proxy to Cloudflare Workers
- ‚û°Ô∏è Move files to R2 storage
- ‚û°Ô∏è Keep permission logic in Convex
- ‚û°Ô∏è Save ~$40/month at high traffic

**Why this decision was simple:**
Access control eliminated most alternatives. The architecture is non-negotiable‚Äîonly the storage backend location is flexible.

## References

### Convex Documentation
- [Convex File Storage](https://docs.convex.dev/file-storage)
- [Convex HTTP Actions](https://docs.convex.dev/functions/http-actions)
- [Convex Authentication](https://docs.convex.dev/auth)
- [Convex Pricing](https://www.convex.dev/pricing)
- [Convex Scheduled Functions](https://docs.convex.dev/scheduling)

### Cloudflare Documentation (Future Migration)
- [Cloudflare Workers](https://developers.cloudflare.com/workers/)
- [Cloudflare R2](https://developers.cloudflare.com/r2/)
- [R2 Pricing](https://developers.cloudflare.com/r2/pricing/)
- [Workers + R2 Integration](https://developers.cloudflare.com/r2/api/workers/workers-api-reference/)

### Architecture Patterns
- [HTTP Proxy Pattern for File Serving](https://martinfowler.com/articles/gateway.html)
- [Multi-Tenant Authorization](https://docs.convex.dev/auth/advanced)
